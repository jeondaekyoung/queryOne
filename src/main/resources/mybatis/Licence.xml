<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
			PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.Licence">
	<select id="liceSelectList" parameterType="java.util.Map" resultType="LicenceKey">
		select liceNo,lice_key,L.writer,L.createDate,L.proNo,product_id from LicenceKey as L join Product ON Product.proNo = L.proNo  order by liceNo DESC
	</select>
	
	<select id="liceSelectOne" parameterType="LicenceKey" resultType="LicenceKey">
		select * from LicenceKey where liceNo=#{liceNo}
	</select>
	
	<select id="liceSelectOne_newest"  parameterType="java.util.Map"  resultType="LicenceKey">
		select * from LicenceKey where proNo=#{proNo} order by liceNo DESC LIMIT 1 
	</select>
	
	<insert id="liceInsert" parameterType="LicenceKey"  useGeneratedKeys="true" keyProperty="liceNo">
	
		insert into LicenceKey values(#{liceNo},#{lice_key},#{writer},#{createDate},#{proNo});
		
	</insert>	
	
	
	<update id="liceUpdate_create" parameterType="LicenceKey">
	UPDATE LicenceKey SET createDate =  ADDTIME(CREATEDATE,CURTIME()) WHERE LICENO =#{liceNo}
		
	</update>
	<update id="liceUpdate" parameterType="LicenceKey">
		update LicenceKey set lice_key=#{lice_key},writer=#{writer},createDate=#{createDate},proNo=#{proNo} WHERE LICENO =#{liceNo}
		
	</update>
	
	<delete id="liceDelete" parameterType="LicenceKey">
		delete from LicenceKey where liceNo=#{liceNo}
	</delete>
	
	<delete id="liceDelete_product" parameterType="java.util.Map">
		delete from LicenceKey where proNo=#{proNo}
	</delete>
	
	<insert id="history_inNup"  parameterType="java.util.Map" >
	
		INSERT INTO History VALUES(CURDATE(),#{lice_key},1) ON DUPLICATE KEY UPDATE HITS=HITS+1;
		
	</insert>
	
	
	<select id="history_SelectList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * FROM (select History.*,@rownum:=@rownum+1 as r from History, (SELECT @rownum:=0) r order by hitDate desc)  a where r between #{start} and #{end} 
		
	</select>
	
	<select id="history_SumHits" parameterType="java.util.Map" resultType="int">
		SELECT sum(hits) FROM History 
	</select>
	
	
</mapper>